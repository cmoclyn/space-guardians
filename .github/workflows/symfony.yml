# This workflow uses actions that are not certified by GitHub.
# They are provided by a third-party and are governed by
# separate terms of service, privacy policy, and support
# documentation.

name: Symfony

on:
    push:
        branches: [ "dev" ]
    pull_request:
        branches: [ "dev" ]

permissions:
    contents: read

jobs:
    symfony-tests:
        runs-on: ubuntu-latest
        steps:
            -   name: Checkout
                uses: actions/checkout@v4
            -   name: Set up Docker Buildx
                uses: docker/setup-buildx-action@v3
            -   name: Build Docker images
                uses: docker/bake-action@v4
                with:
                    pull: true
                    load: true
                    files: |
                        compose.yaml
                    set: |
                        *.cache-from=type=gha,scope=${{github.ref}}
                        *.cache-from=type=gha,scope=refs/heads/main
                        *.cache-to=type=gha,scope=${{github.ref}},mode=max
            -   name: Start services
                run: docker compose up --wait --no-build
            -   name: Copy .env.test.local
                working-directory: ./app
                run: php -r "file_exists('.env.test.local') || copy('.env.test', '.env.test.local');"
            -   name: Install Dependencies
                working-directory: ./app
                run: composer install -q --no-ansi --no-interaction --no-scripts --no-progress --prefer-dist
            -   name: Create Database
                working-directory: ./app
                run: docker compose exec app php bin/console --env=test doctrine:database:create
            -   name: Execute migrations
                working-directory: ./app
                run: docker compose exec app php bin/console --env=test doctrine:migration:migrate --allow-no-migration --no-interaction
            -   name: Execute tests (Unit and Feature tests) via PHPUnit
                working-directory: ./app
                run: docker compose exec app php bin/phpunit
